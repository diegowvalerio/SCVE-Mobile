package net.ddns.scvemarchezanmetais.scvemobile.activitys;

import android.content.DialogInterface;
import android.content.Intent;
import android.content.SharedPreferences;
import android.os.Build;
import android.preference.PreferenceManager;
import android.support.annotation.RequiresApi;
import android.support.v7.app.AlertDialog;
import android.support.v7.app.AppCompatActivity;
import android.os.Bundle;
import android.view.View;
import android.view.ViewGroup;
import android.widget.AdapterView;
import android.widget.ArrayAdapter;
import android.widget.EditText;
import android.widget.ListAdapter;
import android.widget.ListView;
import android.widget.TextView;
import android.widget.Toast;

import com.google.gson.Gson;
import com.google.gson.reflect.TypeToken;

import net.ddns.scvemarchezanmetais.scvemobile.R;
import net.ddns.scvemarchezanmetais.scvemobile.adapters.ADP_Items;
import net.ddns.scvemarchezanmetais.scvemobile.adapters.ADP_Produtos;
import net.ddns.scvemarchezanmetais.scvemobile.banco.DatabaseHelper;
import net.ddns.scvemarchezanmetais.scvemobile.dao.DAOCondPagto;
import net.ddns.scvemarchezanmetais.scvemobile.dao.DAOFormaPag;
import net.ddns.scvemarchezanmetais.scvemobile.dao.DAOItem;
import net.ddns.scvemarchezanmetais.scvemobile.dao.DAOMovimento;
import net.ddns.scvemarchezanmetais.scvemobile.dao.DAOPessoa;
import net.ddns.scvemarchezanmetais.scvemobile.dao.DAOTipoMv;
import net.ddns.scvemarchezanmetais.scvemobile.dao.DAOVendedor;
import net.ddns.scvemarchezanmetais.scvemobile.entidades.Item;
import net.ddns.scvemarchezanmetais.scvemobile.entidades.Movimento;

import java.sql.SQLException;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

public class Novo_Pedido extends AppCompatActivity implements AdapterView.OnItemLongClickListener{
    EditText observacao,cliente,tipoMv,condPagto,formaPag;
    TextView totalvenda;
    String formato = "dd/MM/yyyy";
    private AlertDialog alerta;

    DatabaseHelper dh;

    Movimento movimento = new Movimento();
    DAOMovimento daoMovimento;
    DAOItem daoItem;

    DAOTipoMv daoTipoMv;
    DAOCondPagto daoCondPagto;
    DAOFormaPag daoFormaPag;
    DAOPessoa daoPessoa;
    DAOVendedor daoVendedor;

    List<Item> items = new ArrayList<>();

    ListView listViewProdutos;

    String idvendedor ;

    int V =0;
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_novo__pedido);

        dh = new DatabaseHelper(this);
        try {
            daoMovimento = new DAOMovimento(dh.getConnectionSource());
            daoItem = new DAOItem(dh.getConnectionSource());
            daoTipoMv = new DAOTipoMv(dh.getConnectionSource());
            daoCondPagto = new DAOCondPagto(dh.getConnectionSource());
            daoFormaPag = new DAOFormaPag(dh.getConnectionSource());
            daoPessoa = new DAOPessoa(dh.getConnectionSource());
            daoVendedor = new DAOVendedor(dh.getConnectionSource());
        }catch (SQLException e){
            e.printStackTrace();
        }

        tipoMv = findViewById(R.id.ptitpomv);
        tipoMv.setFocusable(false);
        condPagto = findViewById(R.id.pprazo);
        condPagto.setFocusable(false);
        formaPag = findViewById(R.id.pformapagto);
        formaPag.setFocusable(false);
        cliente = findViewById(R.id.pcliente);
        cliente.setFocusable(false);
        observacao = findViewById(R.id.pedobservacao);
        totalvenda = findViewById(R.id.pedidototalvenda);

        listViewProdutos = findViewById(R.id.listviewProdutos);
        listViewProdutos.setOnItemLongClickListener(this);

        Bundle bundle = getIntent().getExtras();
        idvendedor = bundle.getString("idvendedor");

    }

    public void tipopedido(View view){
        Intent intent = new Intent(this,Novo_Pedido_TipodePedido.class);
        startActivity(intent);
        V = 1;
    }

    public void condpagto(View view){
        Intent intent = new Intent(this,Novo_Pedido_CondPagto.class);
        startActivity(intent);
        V = 2;
    }

    public void formaPag(View view){
        Intent intent = new Intent(this,Novo_Pedido_FormaPag.class);
        startActivity(intent);
        V = 3;
    }
    //pclientes
    public void pclientes(View view){
        Intent intent = new Intent(this,Novo_Pedido_Cliente.class);
        startActivity(intent);
        V = 4;
    }

    public void adicionarProduto(View view) throws SQLException {
       if(movimento.getTipoMv() != null && movimento.getCliente() != null && movimento.getFormaPag() != null && movimento.getCondPagto() != null) {
           gravaMovimento();
           Intent intent = new Intent(this, Novo_Pedido_Adicionar_Produto.class);
           intent.putExtra("idmovimento",movimento.getIdmov());
           intent.putExtra("idtipopedido",movimento.getTipoMv().getIdmv());
           startActivity(intent);
           V = 5;
       }else{
           Toast.makeText(this, "Informe todos os dados !", Toast.LENGTH_SHORT).show();
       }
    }

    private void gravaMovimento() {
        //movimento.setObservacao();
        try {
            Date d = new Date();
            movimento.setDtvenda(d);
            movimento.setObservacao(observacao.getText().toString());
            movimento.setVendedor(daoVendedor.queryForId(Integer.parseInt(idvendedor.toString())));
            daoMovimento.createOrUpdate(movimento);
            Toast.makeText(this, "Cadastrado com sucesso !", Toast.LENGTH_SHORT).show();
        }catch (SQLException e){
            e.printStackTrace();
        }

    }

    @Override
    protected void onStart() {
        super.onStart();
        buscatipopedido();
        buscaCondpagto();
        buscaFormaPag();
        buscaCliente();
        additemLista();
    }

    private void additemLista() {
        if(V==5) {
            try {
                items = new ArrayList<>();
                items.addAll(daoItem.queryBuilder().where().eq("idmv",movimento.getIdmov()).query());
                if (items.size() >0){
                    /*nao permite alterar o tipo de pedido, pois pode variar o valor do item*/
                    tipoMv.setEnabled(false);
                }
            } catch (SQLException e) {
                e.printStackTrace();
            }
            double totalp = 0.0;
            for (Item it: items){
                totalp = totalp + it.getSubtotal();
            }
            movimento.setTotalvenda((float) totalp);
            totalvenda.setText(" R$ "+Double.toString(totalp));

            ADP_Items adp_items = new ADP_Items(this,items);
            listViewProdutos.setAdapter(adp_items);
            setListViewHeightBasedOnChildren(listViewProdutos);
        }

    }

    private void buscatipopedido() {
        SharedPreferences lt = PreferenceManager.getDefaultSharedPreferences(getApplicationContext()); //this.getPreferences(Context.MODE_PRIVATE);
        SharedPreferences.Editor editor = lt.edit();
        String t = lt.getString("idtipopedido","vazio");

        if(V==1) {
            if (!t.equals("vazio")) {
                try {
                    movimento.setTipoMv(daoTipoMv.queryForId(Integer.parseInt(t)));
                    tipoMv.setText(movimento.getTipoMv().getNome().toString());
                    V=0;
               } catch (SQLException e) {
                   e.printStackTrace();
                }
            } else {
                Toast.makeText(this, "Tipo de Pedido Informada inválida", Toast.LENGTH_SHORT).show();
            }
        }
    }

    private void buscaCondpagto() {
        SharedPreferences lt = PreferenceManager.getDefaultSharedPreferences(getApplicationContext()); //this.getPreferences(Context.MODE_PRIVATE);
        SharedPreferences.Editor editor = lt.edit();
        String t = lt.getString("idcondpagto","vazio");

        if(V==2) {
            if (!t.equals("vazio")) {
                try {
                    movimento.setCondPagto(daoCondPagto.queryForId(Integer.parseInt(t)));
                    condPagto.setText(movimento.getCondPagto().getNome().toString());
                    V=0;
                } catch (SQLException e) {
                    e.printStackTrace();
                }
            } else {
                Toast.makeText(this, "Prazo de Pagamento Informado inválido", Toast.LENGTH_SHORT).show();
            }
        }
    }

    private void buscaFormaPag() {
        SharedPreferences lt = PreferenceManager.getDefaultSharedPreferences(getApplicationContext()); //this.getPreferences(Context.MODE_PRIVATE);
        SharedPreferences.Editor editor = lt.edit();
        String t = lt.getString("idformapag","vazio");

        if(V==3) {
            if (!t.equals("vazio")) {
                try {
                    movimento.setFormaPag(daoFormaPag.queryForId(Integer.parseInt(t)));
                    formaPag.setText(movimento.getFormaPag().getNome().toString());
                    V=0;
                } catch (SQLException e) {
                    e.printStackTrace();
                }
            } else {
                Toast.makeText(this, "Forma de Cobrança Informada inválida", Toast.LENGTH_SHORT).show();
            }
        }
    }

    private void buscaCliente() {
        SharedPreferences lt = PreferenceManager.getDefaultSharedPreferences(getApplicationContext()); //this.getPreferences(Context.MODE_PRIVATE);
        SharedPreferences.Editor editor = lt.edit();
        String t = lt.getString("idcliente","vazio");

        if(V==4) {
            if (!t.equals("vazio")) {
                try {
                    movimento.setCliente(daoPessoa.queryForId(Integer.parseInt(t)));
                    cliente.setText(movimento.getCliente().getNome().toString());
                    V=0;
                } catch (SQLException e) {
                    e.printStackTrace();
                }
            } else {
                Toast.makeText(this, "Cliente Informado inválido", Toast.LENGTH_SHORT).show();
            }
        }
    }


    public static void setListViewHeightBasedOnChildren(ListView listView) {
        ListAdapter listAdapter = listView.getAdapter();
        if (listAdapter == null) {
            // pre-condition
            return;
        }

        int totalHeight = 0;
        int desiredWidth = View.MeasureSpec.makeMeasureSpec(listView.getWidth(), View.MeasureSpec.AT_MOST);
        for (int i = 0; i < listAdapter.getCount(); i++) {
            View listItem = listAdapter.getView(i, null, listView);
            listItem.measure(desiredWidth, View.MeasureSpec.UNSPECIFIED);
            totalHeight += listItem.getMeasuredHeight();
        }

        ViewGroup.LayoutParams params = listView.getLayoutParams();
        params.height = totalHeight + (listView.getDividerHeight() * (listAdapter.getCount() - 1));
        listView.setLayoutParams(params);
        listView.requestLayout();
    }



    //opções de editar/excluir items
    @Override
    public boolean onItemLongClick(AdapterView<?> parent, View view, int position, long id) {
        final Item item = (Item) parent.getItemAtPosition(position);
        ArrayList<String> itens = new ArrayList<>();

        itens.add("Editar");
        itens.add("Excluir");

        //adapter utilizando um layout customizado (TextView)
        ArrayAdapter adapter = new ArrayAdapter(this, R.layout.item_alerta, itens);

        final AlertDialog.Builder builder = new AlertDialog.Builder(this);

        builder.setTitle("O que deseja fazer ?");
        builder.setSingleChoiceItems(adapter, 0, new DialogInterface.OnClickListener() {
            @RequiresApi(api = Build.VERSION_CODES.KITKAT)
            public void onClick(DialogInterface arg0, int arg1) {
                //Toast.makeText(Clientes.this, "posição selecionada=" + arg1, Toast.LENGTH_SHORT).show();
                if(arg1 == 0){//Editar
                    Intent intent = new Intent(Novo_Pedido.this, Novo_Pedido_Adicionar_Produto.class);
                    intent.putExtra("iditemmov",item.getIditemmov());
                    intent.putExtra("idmovimento",movimento.getIdmov());
                    intent.putExtra("idtipopedido",movimento.getTipoMv().getIdmv());
                    startActivity(intent);
                    alerta.dismiss();
                }else if(arg1 ==1){//Excluir
                    try {
                        daoItem.delete(item);
                    } catch (SQLException e) {
                        e.printStackTrace();
                    }
                    additemLista();
                    //preencherContatos();
                    alerta.dismiss();
                }
            }
        });
        alerta = builder.create();
        //Exibe
        alerta.show();

        return true;
    }
}
