package net.ddns.scvemarchezanmetais.scvemobile.activitys;

import android.database.DatabaseUtils;
import android.graphics.Color;
import android.support.v7.app.AppCompatActivity;
import android.os.Bundle;
import android.view.View;
import android.view.ViewGroup;
import android.widget.ArrayAdapter;
import android.widget.EditText;
import android.widget.ListAdapter;
import android.widget.ListView;
import android.widget.TabHost;

import net.ddns.scvemarchezanmetais.scvemobile.R;
import net.ddns.scvemarchezanmetais.scvemobile.adapters.ADP_Clientes_Contatos;
import net.ddns.scvemarchezanmetais.scvemobile.adapters.ADP_Clientes_Endereco;
import net.ddns.scvemarchezanmetais.scvemobile.banco.DatabaseHelper;
import net.ddns.scvemarchezanmetais.scvemobile.dao.DAOContato;
import net.ddns.scvemarchezanmetais.scvemobile.dao.DAOEndereco;
import net.ddns.scvemarchezanmetais.scvemobile.dao.DAOJuridica;
import net.ddns.scvemarchezanmetais.scvemobile.dao.DAOPessoa;
import net.ddns.scvemarchezanmetais.scvemobile.dao.DAOPfisica;
import net.ddns.scvemarchezanmetais.scvemobile.dao.DAOTipoEndereco;
import net.ddns.scvemarchezanmetais.scvemobile.entidades.Contato;
import net.ddns.scvemarchezanmetais.scvemobile.entidades.Endereco;
import net.ddns.scvemarchezanmetais.scvemobile.entidades.Pessoa;
import net.ddns.scvemarchezanmetais.scvemobile.entidades.Pfisica;
import net.ddns.scvemarchezanmetais.scvemobile.entidades.Pjuridica;
import net.ddns.scvemarchezanmetais.scvemobile.entidades.TipoEndereco;

import java.sql.SQLException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

public class Formulario_Cliente extends AppCompatActivity {

    EditText p_nome, p_dtcadastro, f_cpf,f_rg, f_dtnasc, j_cnpj,j_razaosocial,j_inscestadual,j_suframa;
    String formato = "dd/MM/yyyy";
    Pessoa pessoa = new Pessoa();


    DatabaseHelper dh;

    DAOPessoa daoPessoa;
    DAOEndereco daoEndereco;
    DAOContato daoContato;
    DAOPfisica daoPfisica;
    DAOJuridica daoJuridica;

    List<Endereco> enderecos = new ArrayList<>();
    List<Contato> contatos = new ArrayList<>();

    TabHost tabHost;
    TabHost tabHost2;

    ListView listViewEndereco;
    ListView listViewContato;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_formulario__cliente);

        tabHost = findViewById(R.id.tabhost);
        tabHost2 = findViewById(R.id.tabhost2);
        tabHost.setup();
        tabHost2.setup();

        TabHost.TabSpec tfisica = tabHost.newTabSpec("Fisíca");
        tfisica.setContent(R.id.Fisíca);
        tfisica.setIndicator("Fisíca");

        TabHost.TabSpec tjuridica = tabHost.newTabSpec("Jurídica");
        tjuridica.setContent(R.id.Jurídica);
        tjuridica.setIndicator("Jurídica");

        TabHost.TabSpec penderecos = tabHost2.newTabSpec("Endereços");
        penderecos.setContent(R.id.Endereços);
        penderecos.setIndicator("Endereços");

        TabHost.TabSpec pcontatos = tabHost2.newTabSpec("Contatos");
        pcontatos.setContent(R.id.Contatos);
        pcontatos.setIndicator("Contatos");

        tabHost.addTab(tfisica);
        tabHost.addTab(tjuridica);
        tabHost2.addTab(penderecos);
        tabHost2.addTab(pcontatos);
/*
        tabHost.setOnTabChangedListener(new TabHost.OnTabChangeListener() {

            @Override
            public void onTabChanged(String tabId) {
                // TODO Auto-generated method stub
                for (int i = 0; i < tabHost.getTabWidget().getChildCount(); i++) {
                    tabHost.getTabWidget().getChildAt(i).setBackgroundColor(Color.parseColor("#FFFFFF")); //unselected
                }
                tabHost.getTabWidget().getChildAt(tabHost.getCurrentTab()).setBackgroundColor(Color.parseColor("#FF3F51B5")); // selected
            }
        });
        tabHost2.setOnTabChangedListener(new TabHost.OnTabChangeListener() {

            @Override
            public void onTabChanged(String tabId) {
                // TODO Auto-generated method stub
                for (int i = 0; i < tabHost2.getTabWidget().getChildCount(); i++) {
                    tabHost2.getTabWidget().getChildAt(i).setBackgroundColor(Color.parseColor("#FFFFFF")); //unselected
                }
                tabHost2.getTabWidget().getChildAt(tabHost2.getCurrentTab()).setBackgroundColor(Color.parseColor("#FF3F51B5")); // selected
            }
        });
*/
        p_nome = findViewById(R.id.p_nome);
        //p_dtcadastro = findViewById(R.id.p_dtcadastro);
        f_cpf = findViewById(R.id.f_cpf);
        f_rg = findViewById(R.id.f_rg);
        f_dtnasc = findViewById(R.id.f_dtnascimento);
        j_cnpj = findViewById(R.id.j_cnpj);
        j_inscestadual = findViewById(R.id.j_inscestadual);
        j_razaosocial = findViewById(R.id.j_razaosocial);
        j_suframa = findViewById(R.id.j_suframa);

        Bundle bundle = getIntent().getExtras();
        if (bundle!=null && bundle.containsKey("idpessoa")){
            dh = new DatabaseHelper(Formulario_Cliente.this);
            try {
                daoPessoa = new DAOPessoa(dh.getConnectionSource());
                daoPfisica = new DAOPfisica(dh.getConnectionSource());
                daoJuridica = new DAOJuridica(dh.getConnectionSource());
            }catch (SQLException e){
                e.printStackTrace();
            }

            try {
                /*dados do cliente*/
                pessoa = daoPessoa.queryForId(bundle.getInt("idpessoa"));

                p_nome.setText(pessoa.getNome());
                //SimpleDateFormat formatter = new SimpleDateFormat(formato);
                //p_dtcadastro.setText(formatter.format(pessoa.getDtcadastro()));
                if (pessoa.getTipojf().equals("F")){
                    Pfisica pfisica ;
                    pfisica = daoPfisica.queryBuilder().where().eq("idpessoa",pessoa.getIdpessoa()).queryForFirst();

                    SimpleDateFormat formatter = new SimpleDateFormat(formato);
                    f_dtnasc.setText(formatter.format(pfisica.getDtnasc()));
                    f_cpf.setText(pfisica.getCpf());
                    f_rg.setText(pfisica.getRg());

                    tabHost.setCurrentTab(0);

                }else if (pessoa.getTipojf().equals("J")){
                    Pjuridica pjuridica ;
                    pjuridica = daoJuridica.queryBuilder().where().eq("idpessoa",pessoa.getIdpessoa()).queryForFirst();

                    j_suframa.setText(pjuridica.getInsc_suframa());
                    j_razaosocial.setText(pjuridica.getRazao_social());
                    j_inscestadual.setText(pjuridica.getInsc_estadual());
                    j_cnpj.setText(pjuridica.getCnpj());

                    tabHost.setCurrentTab(1);
                }

                p_nome.setEnabled(false);
                //p_dtcadastro.setEnabled(false);
                f_cpf.setEnabled(false);
                f_rg.setEnabled(false);
                f_dtnasc.setEnabled(false);
                j_cnpj.setEnabled(false);
                j_inscestadual.setEnabled(false);
                j_razaosocial.setEnabled(false);
                j_suframa.setEnabled(false);
                tabHost.setEnabled(false);


                listViewEndereco = (ListView) findViewById(R.id.listviewEndereco);
                listViewContato = (ListView) findViewById(R.id.listviewContato);



            } catch (SQLException e) {
                e.printStackTrace();
            }
        }

    }
    @Override
    protected void onStart() {
        super.onStart();
        preencherEnderecos();
        preencherContatos();
    }

    private void preencherEnderecos() {
        dh = new DatabaseHelper(Formulario_Cliente.this);
        try {
            daoEndereco = new DAOEndereco(dh.getConnectionSource());
        }catch (SQLException e){
            e.printStackTrace();
        }

        Bundle bundle = getIntent().getExtras();
        if (bundle!=null && bundle.containsKey("idpessoa")) {
            try {
                enderecos.addAll(daoEndereco.queryBuilder().where().eq("idpessoa", bundle.getInt("idpessoa")).query());
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }

        ADP_Clientes_Endereco adp_clientes_endereco = new ADP_Clientes_Endereco(Formulario_Cliente.this,enderecos);
        listViewEndereco.setAdapter(adp_clientes_endereco);
        setListViewHeightBasedOnItems(listViewEndereco);

    }

    private void preencherContatos() {
        dh = new DatabaseHelper(Formulario_Cliente.this);
        try {
            daoContato = new DAOContato(dh.getConnectionSource());
        }catch (SQLException e){
            e.printStackTrace();
        }

        Bundle bundle = getIntent().getExtras();
        if (bundle!=null && bundle.containsKey("idpessoa")) {
            try {
                contatos.addAll(daoContato.queryBuilder().where().eq("idpessoa", bundle.getInt("idpessoa")).query());
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }

        ADP_Clientes_Contatos adp_clientes_contatos = new ADP_Clientes_Contatos(Formulario_Cliente.this,contatos);
        listViewContato.setAdapter(adp_clientes_contatos);
        setListViewHeightBasedOnItems(listViewContato);

    }

    /*teste*/
    public static boolean setListViewHeightBasedOnItems(ListView listView) {

        ListAdapter listAdapter = listView.getAdapter();
        if (listAdapter != null) {

            int numberOfItems = listAdapter.getCount();

            // Get total height of all items.
            int totalItemsHeight = 0;
            for (int itemPos = 0; itemPos < numberOfItems; itemPos++) {

                float px = 300 * (listView.getResources().getDisplayMetrics().density);

                View item = listAdapter.getView(itemPos, null, listView);
                item.measure(View.MeasureSpec.makeMeasureSpec((int)px, View.MeasureSpec.AT_MOST), View.MeasureSpec.makeMeasureSpec(0, View.MeasureSpec.UNSPECIFIED));
                totalItemsHeight += item.getMeasuredHeight();
            }

            // Get total height of all item dividers.
            int totalDividersHeight = listView.getDividerHeight() * (numberOfItems - 1);
            // Get padding
            int totalPadding = listView.getPaddingTop() + listView.getPaddingBottom();

            // Set list height.
            ViewGroup.LayoutParams params = listView.getLayoutParams();
            params.height = totalItemsHeight + totalDividersHeight + totalPadding;
            listView.setLayoutParams(params);
            listView.requestLayout();

            return true;

        } else {
            return false;
        }

    }
}
